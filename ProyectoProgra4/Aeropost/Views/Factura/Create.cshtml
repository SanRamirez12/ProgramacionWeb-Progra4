@model Aeropost.Models.Factura

@{
    ViewData["Title"] = "Crear Factura";
    var clientes = ViewBag.Clientes as List<Aeropost.Models.Cliente> ?? new List<Aeropost.Models.Cliente>();
}

<div class="bitacora-container">
    <!-- Sección de bienvenida -->
    <div class="welcome-section">
        <h1 class="welcome-title">Crear Nueva Factura</h1>
    </div>

    <!-- Contenido principal -->
    <div class="main-content-card">
        <form asp-action="Create" method="post" class="client-form">
            @Html.AntiForgeryToken()

            <!-- Resumen de errores de validación -->
            <div asp-validation-summary="ModelOnly" class="validation-summary"></div>

            <!-- Grid del formulario -->
            <div class="form-grid">
                <!-- Selección de Cliente -->
                <div class="form-group">
                    <label class="form-label" for="CedulaCliente">
                       
                        Cédula del Cliente
                    </label>
                    <select id="CedulaCliente" name="CedulaCliente" class="form-select">
                        <option value="">-- Seleccione un cliente --</option>
                        @foreach (var c in clientes)
                        {
                            if (Model?.CedulaCliente == c.Cedula)
                            {
                                <option value="@c.Cedula" selected="selected">@c.Cedula</option>
                            }
                            else
                            {
                                <option value="@c.Cedula">@c.Cedula</option>
                            }
                        }
                    </select>
                </div>

                <!-- Fecha de Entrega -->
                <div class="form-group">
                    <label asp-for="FechaEntrega" class="form-label">
                        
                        Fecha de Entrega
                    </label>
                    <input asp-for="FechaEntrega" class="form-input" type="date" />
                    <span asp-validation-for="FechaEntrega" class="field-validation"></span>
                </div>
            </div>

            <!-- Datos del Cliente (solo lectura) -->
            <div class="info-card" style="margin-bottom: 2rem;">
                <h3 class="subsection-title">Datos del Cliente</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">
                            
                            Nombre
                        </label>
                        <input id="CliNombre" class="form-input" readonly />
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            
                            Correo
                        </label>
                        <input id="CliCorreo" class="form-input" readonly />
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            
                            Teléfono
                        </label>
                        <input id="CliTelefono" class="form-input" readonly />
                    </div>
                    <div class="form-group form-group-wide">
                        <label class="form-label">
                          
                            Dirección
                        </label>
                        <input id="CliDireccion" class="form-input" readonly />
                    </div>
                </div>
            </div>

            <!-- Selección de Paquete -->
            <div class="form-grid" style="margin-bottom: 2rem;">
                <div class="form-group form-group-wide">
                    <label class="form-label" for="NumeroTracking">
                        
                        Número de Tracking
                    </label>
                    <select id="NumeroTracking" name="NumeroTracking" class="form-select" disabled>
                        <option value="">-- Seleccione un paquete --</option>
                    </select>
                    <span asp-validation-for="NumeroTracking" class="field-validation"></span>
                </div>
            </div>

            <!-- Datos del Paquete (solo lectura) -->
            <div class="info-card" style="margin-bottom: 2rem;">
                <h3 class="subsection-title">Datos del Paquete</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label asp-for="Peso" class="form-label">
                            
                            Peso (kg)
                        </label>
                        <input asp-for="Peso" id="Peso" class="form-input" disabled />
                    </div>
                    <div class="form-group">
                        <label asp-for="ValorTotalPaquete" class="form-label">
                            
                            Valor Total del Paquete
                        </label>
                        <input asp-for="ValorTotalPaquete" id="ValorTotalPaquete" class="form-input" disabled />
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <span class="label-icon">⭐</span>
                            Producto Especial
                        </label>
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                            <input class="form-check-input" asp-for="EsProductoEspecial" id="EsProductoEspecial" disabled style="margin: 0;" />
                            <span style="color: #4a4a4a;">Sí, es producto especial</span>
                        </div>
                        <input type="hidden" asp-for="EsProductoEspecial" />
                    </div>
                    <div class="form-group">
                        <label asp-for="MontoTotal" class="form-label">
                           
                            Monto Total
                        </label>
                        <input asp-for="MontoTotal" id="MontoTotal" class="form-input" disabled />
                    </div>
                </div>
            </div>

            <!-- Botones de acción -->
            <div class="form-actions">
                <button type="submit" class="btn-submit">
                    
                    Crear Factura
                </button>
                <a asp-action="Index" class="btn-submit">
                   
                    Volver
                </a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        (function(){
            const selCedula = document.getElementById('CedulaCliente');
            const selTrack  = document.getElementById('NumeroTracking');

            // Cliente fields
            const fNombre   = document.getElementById('CliNombre');
            const fCorreo   = document.getElementById('CliCorreo');
            const fTel      = document.getElementById('CliTelefono');
            const fDir      = document.getElementById('CliDireccion');

            // Paquete/Monto preview
            const inpPeso   = document.getElementById('Peso');
            const inpValor  = document.getElementById('ValorTotalPaquete');
            const chkEsp    = document.getElementById('EsProductoEspecial');
            const inpMonto  = document.getElementById('MontoTotal');

            // Al cambiar CÉDULA: 1) trae datos del cliente, 2) carga trackings
            selCedula.addEventListener('change', async function(){
                limpiarCliente();
                limpiarPaquete();
                selTrack.innerHTML = '<option value="">-- Seleccione un paquete --</option>';
                selTrack.disabled = true;

                const ced = this.value;
                if(!ced) return;

                try{
                    // 1) Datos del cliente
                    const urlCli = '@Url.Action("ClientePorCedula", "Cliente")' + '?cedula=' + encodeURIComponent(ced);
                    const rCli = await fetch(urlCli);
                    const cli = await rCli.json();
                    if (cli) {
                        fNombre.value = cli.nombre || '';
                        fCorreo.value = cli.correo || '';
                        fTel.value    = cli.telefono || '';
                        fDir.value    = cli.direccion || '';
                    }

                    // 2) Paquetes del cliente
                    const urlPaq = '@Url.Action("PaquetesPorCedula", "Factura")' + '?cedula=' + encodeURIComponent(ced);
                    const rPaq = await fetch(urlPaq);
                    const paqs = await rPaq.json();

                    paqs.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.tracking;
                        opt.textContent = p.tracking;
                        opt.dataset.peso = p.peso;
                        opt.dataset.valor = p.valor;
                        opt.dataset.especial = p.especial ? 'true' : 'false';
                        selTrack.appendChild(opt);
                    });

                    selTrack.disabled = paqs.length === 0;
                }catch(e){
                    console.error(e);
                }
            });

            // Al cambiar TRACKING: pinta la vista previa de paquete/monto
            selTrack.addEventListener('change', function(){
                const opt = this.selectedOptions[0];
                if(!opt || !opt.value){ limpiarPaquete(); return; }

                const peso = parseFloat(opt.dataset.peso || '0');
                const valor = parseFloat(opt.dataset.valor || '0');
                const especial = (opt.dataset.especial === 'true');

                inpPeso.value  = peso.toFixed(2);
                inpValor.value = valor.toFixed(2);
                chkEsp.checked = especial;

                // preview (el Service recalcula al guardar)
                const base = peso * 12.0;
                const iva  = valor * 0.13;
                const adic = especial ? (valor * 0.10) : 0;
                const total = Math.round((base + iva + adic) * 100) / 100;
                inpMonto.value = total.toFixed(2);
            });

            function limpiarCliente(){
                fNombre.value = ''; fCorreo.value = ''; fTel.value = ''; fDir.value = '';
            }
            function limpiarPaquete(){
                inpPeso.value = ''; inpValor.value=''; chkEsp.checked=false; inpMonto.value='';
            }
        })();
    </script>
}